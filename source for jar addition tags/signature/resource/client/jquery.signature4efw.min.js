/* http://keith-wood.name/signature.html
   Signature plugin for jQuery UI v1.1.2.
   Requires excanvas.js in IE.
   Written by Keith Wood (kbwood{at}iinet.com.au) April 2012.
   Available under the MIT (http://keith-wood.name/licence.html) license. 
   Please attribute the author if you use it. */
!function(a){var b={options:{distance:0,background:"#ffffff",color:"#000000",thickness:2,guideline:!1,guidelineColor:"#a0a0a0",guidelineOffset:50,guidelineIndent:10,notAvailable:"Your browser doesn't support signing",syncField:null,change:null},_create:function(){this.element.addClass(this.widgetFullName||this.widgetBaseClass);try{this.canvas=a('<canvas width="'+this.element.width()+'" height="'+this.element.height()+'">'+this.options.notAvailable+"</canvas>")[0],this.element.append(this.canvas),this.ctx=this.canvas.getContext("2d")}catch(b){a(this.canvas).remove(),this.resize=!0,this.canvas=document.createElement("canvas"),this.canvas.setAttribute("width",this.element.width()),this.canvas.setAttribute("height",this.element.height()),this.canvas.innerHTML=this.options.notAvailable,this.element.append(this.canvas),G_vmlCanvasManager&&G_vmlCanvasManager.initElement(this.canvas),this.ctx=this.canvas.getContext("2d")}this._refresh(!0),this._mouseInit()},_refresh:function(b){if(this.resize){var c=a(this.canvas);a("div",this.canvas).css({width:c.width(),height:c.height()})}this.ctx.fillStyle=this.options.background,this.ctx.strokeStyle=this.options.color,this.ctx.lineWidth=this.options.thickness,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.clear(b)},clear:function(a){this.ctx.clearRect(0,0,this.element.width(),this.element.height()),this.options.guideline&&(this.ctx.save(),this.ctx.strokeStyle=this.options.guidelineColor,this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(this.options.guidelineIndent,this.element.height()-this.options.guidelineOffset),this.ctx.lineTo(this.element.width()-this.options.guidelineIndent,this.element.height()-this.options.guidelineOffset),this.ctx.stroke(),this.ctx.restore()),this.lines=[],a||this._changed()},_changed:function(b){this.options.syncField&&a(this.options.syncField).val(this.toJSON()),this._trigger("change",b,{})},_setOptions:function(b){this._superApply?this._superApply(arguments):a.Widget.prototype._setOptions.apply(this,arguments),this._refresh()},_mouseCapture:function(a){return!this.options.disabled},_mouseStart:function(a){this.offset=this.element.offset(),this.offset.left-=document.documentElement.scrollLeft||document.body.scrollLeft,this.offset.top-=document.documentElement.scrollTop||document.body.scrollTop,this.lastPoint=[this._round(a.clientX-this.offset.left),this._round(a.clientY-this.offset.top)],this.curLine=[this.lastPoint],this.lines.push(this.curLine)},_mouseDrag:function(a){var b=[this._round(a.clientX-this.offset.left),this._round(a.clientY-this.offset.top)];this.curLine.push(b),this.ctx.beginPath(),this.ctx.moveTo(this.lastPoint[0],this.lastPoint[1]),this.ctx.lineTo(b[0],b[1]),this.ctx.stroke(),this.lastPoint=b},_mouseStop:function(a){1===this.curLine.length&&(a.clientY+=this.options.thickness,this._mouseDrag(a)),this.lastPoint=null,this.curLine=null,this._changed(a)},_round:function(a){return Math.round(100*a)/100},toJSON:function(){return'{"lines":['+a.map(this.lines,function(b){return"["+a.map(b,function(a){return"["+a+"]"})+"]"})+"]}"},toSVG:function(){return'<?xml version="1.0"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n<svg xmlns="http://www.w3.org/2000/svg" width="'+this.canvas.width+'" height="'+this.canvas.height+'">\n\t<g fill="'+this.options.background+'">\n\t\t<rect x="0" y="0" width="'+this.canvas.width+'" height="'+this.canvas.height+'"/>\n\t\t<g fill="none" stroke="'+this.options.color+'" stroke-width="'+this.options.thickness+'">\n'+a.map(this.lines,function(b){return'\t\t\t<polyline points="'+a.map(b,function(a){return a+""}).join(" ")+'"/>\n'}).join("")+"\t\t</g>\n\t</g>\n</svg>\n"},draw:function(b){this.clear(!0),"string"==typeof b&&(b=a.parseJSON(b)),this.lines=b.lines||[];var c=this.ctx;a.each(this.lines,function(){c.beginPath(),a.each(this,function(a){c[0===a?"moveTo":"lineTo"](this[0],this[1])}),c.stroke()}),this._changed()},isEmpty:function(){return 0===this.lines.length},_destroy:function(){this.element.removeClass(this.widgetFullName||this.widgetBaseClass),a(this.canvas).remove(),this.canvas=this.ctx=this.lines=null,this._mouseDestroy()}};a.Widget.prototype._destroy||a.extend(b,{destroy:function(){this._destroy(),a.Widget.prototype.destroy.call(this)}}),a.Widget.prototype._getCreateOptions===a.noop&&a.extend(b,{_getCreateOptions:function(){return a.metadata&&a.metadata.get(this.element[0])[this.widgetName]}}),a.widget("kbw.signature",a.ui.mouse,b),a.kbw.signature.options=a.kbw.signature.prototype.options}(jQuery);
